<html lang="en"><head> <meta charset="utf-8"> <title> Role of block-level boxes and block formatting contexts in margin collapse | Annotated CSS Spec </title> <meta name="description" content="Broaden your CSS knowledge by reading a specification enriched with explanations and examples."> <meta name="viewport" content="width=device-width,initial-scale=1"> <meta name="robots" content="noindex"> <meta property="og:title" content="Annotated CSS Spec"> <meta property="og:url" content="https://annotatedcss.com"> <meta property="og:description" content="Broaden your CSS knowledge by reading an annotated specification!"> <meta property="og:image" content="/images/logo.png"> <meta property="og:type" content="website"> <meta property="og:image:width" content="300"> <meta property="og:image:height" content="300"> <link href="https://fonts.googleapis.com/css2?family=Inconsolata&amp;family=Open+Sans:ital,wght@0,400;0,600;1,300;1,400&amp;display=swap" rel="stylesheet"> <link rel="stylesheet" href="/styles/main.css"> <link rel="icon" type="image/png" href="/images/favicon-16x16.png" sizes="16x16"> <link rel="icon" type="image/png" href="/images/favicon-32x32.png" sizes="32x32"> <link rel="icon" type="image/png" href="/images/favicon-96x96.png" sizes="96x96"> </head> <body> <header> <svg class="logo" xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 41.01 41.01"><g class="marginBox" fill="none" stroke="#ececfb" stroke-width="2.646"><path d="M1.323 7.938V1.323h6.615M1.323 11.898v6.614M1.323 22.488v6.614M7.937 39.688H1.323v-6.615M39.688 7.938V1.323h-6.615M39.688 11.898v6.614M39.688 22.488v6.614M33.073 39.688h6.614v-6.615M11.906 1.318h6.615M22.49 1.318h6.614M11.906 39.688h6.615M22.49 39.688h6.614"></path></g><rect class="borderBox" ry="0" height="25.261" width="25.261" y="7.87" x="7.875" opacity=".99" fill="none" stroke="#ececfb" stroke-width="2.52" stroke-linecap="round"></rect><rect class="contentBox" ry="0" height="14.552" width="14.552" y="13.23" x="13.229" opacity=".99" fill="#c7a6e7ff"></rect></svg> <a class="title" href="/">Annotated CSS&nbsp;Spec </a><a class="help-link" href="/about">?</a> </header> <main> <article class="spec-comment open" data-comment-on="/box-model.html"> <div class="content"> <div class="comment-identifier"> This comment relates to the following words from Section&nbsp;8.3.1 of CSS&nbsp;2.2: <blockquote> Two margins are adjoining if and only if: … both belong to in⁠-⁠flow block⁠-⁠level boxes that participate in the same block formatting context … </blockquote> </div> <p> To understand this point well, you need to be familiar with three concepts which have not yet been introduced in the spec: </p> <ul> <li> block⁠-⁠level boxes, defined in <a href="https://www.w3.org/TR/CSS22/visuren.html#block-boxes">Section&nbsp;9.2.1 block⁠-⁠level elements and block boxes</a> </li> <li> in⁠-⁠flow elements, defined in <a href="https://www.w3.org/TR/CSS22/visuren.html#positioning-scheme">Section&nbsp;9.3 Positioning schemes</a> </li> <li> block formatting contexts, discussed in <a href="https://www.w3.org/TR/CSS22/visuren.html#block-formatting">Section&nbsp;9.4.1 Block formatting contexts</a> </li> </ul> <p> I’ll discuss these concepts here, but only with regard to margin collapse. For more context, consult the relevant sections of the spec. </p> <p> We’ll start from formatting contexts. A formatting context is a rectangular area in which boxes are laid out in a specific way. The CSS standard defines a few types of formatting contexts, among them a block formatting context, often shortened to “BFC”. </p> <p> As <a href="https://www.w3.org/TR/CSS22/visuren.html#block-formatting">Section&nbsp;9.4.1</a> specifies, in a BFC, <q>boxes are laid out one after the other, vertically, beginning at the top of a containing block</q>. Imagine a <code class="language-html">&lt;body&gt;</code> element which contains three consecutive <code class="language-html">&lt;p&gt;</code> elements. With default CSS values, the boxes for these <code class="language-html">&lt;p&gt;</code> elements will participate in a BFC. That is, these boxes will be positioned precisely as the quote describes: <q>one after the other, vertically, beginning at the top of a containing block</q>. (The containing block in this example will be the content edge of the <code class="language-html">&lt;body&gt;</code> box.) </p> <p> A box which participates in a block formatting context is called a block⁠-⁠level box. So, in our example from the previous paragraph, the boxes for the <code class="language-html">&lt;p&gt;</code> elements will be block⁠-⁠level boxes. </p> <p>The last concept to unpack is that of in⁠-⁠flow boxes.</p> <p> When the browser lays out boxes in a formatting context, it positions them using a specific <em>flow</em>. For example, as we have learned, boxes <em>flow</em> vertically in a BFC, one after another. It is possible, though, to take a box out of such a flow. One way is to use absolute positioning to specify that a box should always be displayed at the bottom of the viewport. In such a case, this box is taken out of its default flow: it becomes an out⁠-⁠of⁠-⁠flow box. Conversely, a box which is not taken out flow is an in⁠-⁠flow box. </p> <p> Having reviewed the necessary concepts, we can now discuss the commented fragment of the spec. It says that two margins are adjoining (and so collapse) if <q>both belong to in⁠-⁠flow block⁠-⁠level boxes that participate in the same block formatting context</q>. </p> <p> As the fragment explains, for two margins to be adjoining, it is not enough for their boxes to be in⁠-⁠flow and block⁠-⁠level. These boxes also need to participate in the <em>same</em> block formatting context. Let’s see an example. </p> <p>Suppose we have this HTML:</p> <pre><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
  ...
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>section</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>Paragraph<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>section</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span></code></pre> <p> Let’s assume that all elements in this example have their default CSS settings. This means they are block⁠-⁠level boxes (because of <code class="language-css">display: block</code>), and so participate in a block formatting context. </p> <p> Importantly, the box for <code class="language-html">&lt;body&gt;</code>, the box for <code class="language-css">&lt;section&gt;</code>, and the box for <code class="language-html">&lt;p&gt;</code> all participate in the <em>same</em> block formatting context. This is the context established by the root element, i.e.&nbsp;<code class="language-html">&lt;html&gt;</code>. </p> <p> The fact that these boxes participate in the same BFC makes margin collapse possible. In our example, if we set margins on the box for <code class="language-html">&lt;section&gt;</code> and the box for <code class="language-html">&lt;p&gt;</code>, the top margin of the section box will collapse with the top margin of the paragraph box. The bottom margins of these two boxes will collapse, too. </p> <p> Relatively easily, we can change our example such that the boxes for <code class="language-html">&lt;body&gt;</code>, <code class="language-css">&lt;section&gt;</code>, and <code class="language-html">&lt;p&gt;</code> are no longer all in the same block formatting context. For instance, we can make the box for <code class="language-html">&lt;section&gt;</code> establish a new BFC. </p> <p> If we do so, the <code class="language-html">&lt;section&gt;</code> box will still participate in the BFC established by <code class="language-html">&lt;html&gt;</code>. However, the box for <code class="language-html">&lt;p&gt;</code> will now participate in the BFC established by <code class="language-html">&lt;section&gt;</code>. As a result, the margins of <code class="language-html">&lt;p&gt;</code> will now be in a different block formatting context than the margins of <code class="language-html">&lt;section&gt;</code>. So, as the commented fragment of the spec tells us, margin collapse is prevented in this case. </p> <img src="/images/8.3.1.9-new-bfc-preventing-margin-collapse.svg" alt="Two boxes, one for a <section> element, the other for a <p>
      element. The <section> box is the parent of the <p> box. Both
      boxes have top and bottom margins. The <section> box establishes a new
      block formatting context, with the result that the margins of the parent box
      do not collapse with the boxes of the child box."> <p> CSS&nbsp;2 does not have any property meant specifically for establishing a new BFC. Instead, there are properties that establish a new BFC as a “side effect”. For example, if we set <code class="language-css">overflow: hidden</code> on a block⁠-⁠level box, this box will establish a new BFC but the setting will also change how the box behaves when its content doesn’t fit. </p> <p> Side note: <a href="https://drafts.csswg.org/css-display">CSS Display Module Level&nbsp;3</a> defines a way to establish a new BFC explicitly, without side effects. This is done via <a href="https://drafts.csswg.org/css-display/#valdef-display-flow-root"><code class="language-css">display: flow-root</code></a>. </p> <section class="why-only-bfc"> <h1>Why does margin collapse apply to a BFC only?</h1> <p> The short answer is: because it makes less sense in other formatting contexts. Read on for the long answer! </p> <p> As I noted in <a href="/box-model/comments/8.3.1.1">another comment</a>, margin collapse exists mainly to help maintain more consistent spacing in textual documents. Such documents consist of major elements such as paragraphs, headings, and illustrations. We usually want these elements to be laid out vertically, e.g. first a heading, then a paragraph below the heading, then another paragraph&nbsp;etc. The BFC is well⁠-⁠suited for this kind of layout. </p> <p> So, margin collapse is helpful in textual documents, and the main components of textual documents are laid out using BFCs. Consequently, margin collapse applies in BFCs. </p> <p> Apart from block formatting contexts, CSS&nbsp;2 defines inline and table formatting contexts. In both of these other contexts, margins play a lesser role. </p> <p> I’ll start the explanation from inline formatting contexts. In Section&nbsp;8.3, the spec states that <code class="language-css">margin-top</code> and <code class="language-css">margin-bottom</code> <q>have no effect on non⁠-⁠replaced inline elements</q>. An example of a non⁠-⁠replaced inline element is <code class="language-html">&lt;a&gt;</code>, as long as we don’t change its default setting of <code class="language-css">display: inline</code>. The quoted fragment means that even if we applied a large top margin to our <code class="language-html">&lt;a&gt;</code> element, the document will still look as if no margin was applied. </p> <p> Thus, margin collapse would not even be possible between two non⁠-⁠replaced inline elements. Granted, there are also <em>replaced</em> inline elements. An example is an <code class="language-html">&lt;img&gt;</code>, with its default <code class="language-css">display</code> value of <code class="language-css">inline</code>. For such elements, vertical margins do have an effect on the rendered page. So, margin collapse could theoretically apply to these margins. </p> <p class="alternative"> However, this hypothetical inline margin collapse would add complexity, without bringing a lot of value. The complexity would consist in the browser now needing to track every replaced inline⁠-⁠level box to check if any of the box’s vertical margins happens to be adjacent to a vertical margin of another replaced inline box. </p> <p> With this type of collapse, laying out boxes in an inline formatting context would become more unpredictable. Imagine a paragraph which, apart from text, contains some inline images with vertical margins. If margin collapse was possible between the images, and if two images happened to be placed such that one is right above the other, then this would have to affect the positioning of at least one of the images. This would hardly be a desired effect. </p> <img src="/images/8.3.1.9-hypothetical-margin-collapse-for-inline-elements.svg" alt="Illustration presenting a paragraph with instructions for some recording
        device. Each line of the instructions contains an inline image. The illustration
        demonstrates how margin collapse, if it was allowed between the inline images,
        would negatively affect the spacing between the lines of the instructions."> <p> Let’s now move to table formatting contexts. In these, margins are even less important than in inline formatting contexts. In fact, margins don’t apply at all in a table formatting context. So, margin collapse has no reason to exist there. </p> <p> Note that it is possible to set margins on the table itself and on the table caption. With one exception, the browser will happily show these margins. This is because neither the box for the table (<code class="language-css">display: table</code> or <code class="language-css">display: inline-table</code>) nor the box for the caption (<code class="language-css">display: table-caption</code>) participate in a table formatting context. </p> <p> It is only the contents of the table (the cells, row, columns) that participate in a table formatting context. </p> <p> If you’d like to understand more about how CSS handles tables, be sure to visit <a href="https://www.w3.org/TR/CSS22/tables.html">Chapter&nbsp;17</a> to learn more about table formatting contexts. </p> </section> <section id="why-is-bfc-required"> <h1>Why is the same BFC required for margin collapse?</h1> <p> When a box establishes a new block formatting context, CSS treats this box in a special way. It is almost as if this box creates a “mini page”. </p> <p> Let me explain what I mean by “mini page” via an example, which uses this HTML: </p> <pre><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">…</span> <span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>section</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>De Finibus…<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
      [Text of Section 1.10.32 from Cicero’s
      De Finibus Bonorum et Malorum]
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>section</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></code></pre> <p> Actually, there will be two examples. They will use the same CSS, except that in the second example, the <code class="language-html">&lt;section&gt;</code> element will establish a new BFC, via <code class="language-css">overflow: hidden</code>. </p> <p>The differences in the output are easy to see:</p> <div id="ex-8.3.1.16-i" class="example-visualization"> <style> #ex-8\.3\.1\.16-i .case-1,
          #ex-8\.3\.1\.16-i .case-2 {
            border: solid thin #686892;
            margin: 5px;
          }

          #ex-8\.3\.1\.16-i .case-1 {
            margin-bottom: 10px;
          }

          #ex-8\.3\.1\.16-i section {
            margin: 10px;
          }

          #ex-8\.3\.1\.16-i section.visible-outline {
            outline: solid;
          }

          #ex-8\.3\.1\.16-i .case-2 section {
            overflow: hidden;
          }

          #ex-8\.3\.1\.16-i h1 {
            color: initial;
            font-size: 1.2em;
            margin: 10px 0;
          }

          #ex-8\.3\.1\.16-i img {
            float: left;
            margin: 5px;
          }

          #ex-8\.3\.1\.16-i-show-outline:checked
            ~ .example-frame
            .case-1
            section,
          #ex-8\.3\.1\.16-i-show-outline:checked
            ~ .example-frame
            .case-2
            section {
            outline: solid;
          } </style> <input id="ex-8.3.1.16-i-show-outline" class="show-outline" type="checkbox"><label for="ex-8.3.1.16-i-show-outline">Show the outline of the <code class="language-html">&lt;section&gt;</code> box</label> <div class="example-frame"> <div class="case-1"> <img alt="Bust of Marcus Tulius Cicero" height="134" src="/images/Marcus-Tulius-Cicero.jpg" width="100"> <section> <h1>Example&nbsp;A</h1> <p> Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, totam rem aperiam, eaque ipsa quae ab illo inventore veritatis et quasi architecto beatae vitae dicta sunt explicabo. (…) </p> </section> </div> <div class="case-2"> <img alt="Bust of Marcus Tulius Cicero" height="134" src="/images/Marcus-Tulius-Cicero.jpg" width="100"> <section> <h1>Example&nbsp;B</h1> <p> Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, totam rem aperiam, eaque ipsa quae ab illo inventore veritatis et quasi architecto beatae vitae dicta sunt explicabo. (…) </p> </section> </div> </div> </div> <p> A key component of this example is the float. If you use the checkbox to display the outline of the <code class="language-html">&lt;section&gt;</code> box, you’ll see that in the first example, the <code class="language-html">&lt;section&gt;</code> box overlaps the floated image. This is expected: block⁠-⁠level boxes behave <em>almost</em> as if floats weren’t there. </p> <p> I say “almost” because the lines of text in Example&nbsp;A clearly stay clear of the float. This avoidance is a characteristic feature of floats. It allows text to flow alongside an image, as in printed books. </p> <p> The outline of the <code class="language-html">&lt;section&gt;</code> box in Example&nbsp;B reveals a different situation: not only the lines of text, but the entire box keeps away from the float. This is caused by the fact that in Example&nbsp;B, the <code class="language-html">&lt;section&gt;</code> establishes a new BFC. </p> <p> This effect is in line with the spec. As <a href="https://www.w3.org/TR/CSS22/visuren.html#bfc-next-to-float">Section&nbsp;9.5</a> says: <q cite="https://www.w3.org/TR/CSS22/visuren.html#bfc-next-to-float">The border box of (…) an element in the normal flow that establishes a new block formatting context (…) must not overlap the margin box of any floats in the same block formatting context as the element itself.</q> </p> <p> The example shows how a box which establishes a new BFC becomes “its own thing”. Put differently, the box becomes a “mini page”, one that no longer interacts with certain other boxes. </p> <p> This lack of interaction is also apparent in margin collapse. In Example&nbsp;B, there is more whitespace above the heading than in Example&nbsp;A. Both the <code class="language-html">&lt;section&gt;</code> box and the <code class="language-html">h1</code> box have a top margin. In Example&nbsp;A, both these margins are in the same BFC, so they collapse. This is not the case in Example&nbsp;B. </p> </section> </div> <div class="copyright-notice"> <p> <img alt="Creative Commons License" src="/images/CC_BY-SA_small.svg"> This work by <span xmlns:cc="http://creativecommons.org/ns#" property="cc:attributionName">Mateusz Sarnecki</span> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>. </p> </div> </article> </main> <script src="/scripts/main.js"></script> <!-- GoatCounter, privacy-sensitive web analytics --> <script data-goatcounter="https://msar.goatcounter.com/count" async="" src="//gc.zgo.at/count.js"></script> </body></html>